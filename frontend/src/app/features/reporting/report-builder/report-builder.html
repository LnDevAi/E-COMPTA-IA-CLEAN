<div class="report-builder-container">
  
  <!-- En-tête -->
  <div class="header-section">
    <div class="header-content">
      <div class="header-info">
        <h1>Générateur de rapports</h1>
        <p class="subtitle">Créez et personnalisez vos rapports d'entreprise</p>
      </div>
      <div class="header-actions">
        <button mat-raised-button color="primary" (click)="generateReport()" [disabled]="!selectedTemplate || isLoading">
          <mat-icon>assessment</mat-icon>
          Générer le rapport
        </button>
        <button mat-raised-button (click)="createNewReport()">
          <mat-icon>add</mat-icon>
          Nouveau rapport
        </button>
      </div>
    </div>
  </div>

  <div class="content-grid">
    
    <!-- Panneau de configuration -->
    <div class="config-panel">
      
      <!-- Sélection de template -->
      <mat-card class="template-card">
        <mat-card-header>
          <mat-card-title>
            <mat-icon>description</mat-icon>
            Modèles de rapports
          </mat-card-title>
        </mat-card-header>
        
        <mat-card-content>
          <div class="template-list">
            <div *ngFor="let template of reportTemplates" 
                 class="template-item" 
                 [class.selected]="selectedTemplate?.id === template.id"
                 (click)="selectTemplate(template)">
              <div class="template-info">
                <h4>{{ template.name }}</h4>
                <p>{{ template.description }}</p>
                <mat-chip>{{ template.category }}</mat-chip>
              </div>
            </div>
          </div>
        </mat-card-content>
      </mat-card>

      <!-- Configuration du rapport -->
      <mat-card class="config-card" *ngIf="selectedTemplate">
        <mat-card-header>
          <mat-card-title>
            <mat-icon>settings</mat-icon>
            Configuration
          </mat-card-title>
        </mat-card-header>
        
        <mat-card-content>
          <form [formGroup]="reportForm" class="report-form">
            <mat-form-field appearance="outline">
              <mat-label>Nom du rapport</mat-label>
              <input matInput formControlName="name" placeholder="Nom du rapport">
            </mat-form-field>
            
            <mat-form-field appearance="outline">
              <mat-label>Description</mat-label>
              <textarea matInput formControlName="description" rows="2" placeholder="Description du rapport"></textarea>
            </mat-form-field>
            
            <mat-form-field appearance="outline">
              <mat-label>Catégorie</mat-label>
              <mat-select formControlName="category">
                <mat-option *ngFor="let category of reportCategories" [value]="category.value">
                  {{ category.label }}
                </mat-option>
              </mat-select>
            </mat-form-field>
            
            <mat-form-field appearance="outline">
              <mat-label>Source de données</mat-label>
              <mat-select formControlName="dataSource">
                <mat-option *ngFor="let source of dataSources" [value]="source.value">
                  {{ source.label }}
                </mat-option>
              </mat-select>
            </mat-form-field>
            
            <mat-form-field appearance="outline">
              <mat-label>Type de visualisation</mat-label>
              <mat-select formControlName="chartType">
                <mat-option *ngFor="let type of chartTypes" [value]="type.value">
                  {{ type.label }}
                </mat-option>
              </mat-select>
            </mat-form-field>
            
            <div class="form-actions">
              <button mat-raised-button color="primary" (click)="saveReport()">
                <mat-icon>save</mat-icon>
                Sauvegarder
              </button>
            </div>
          </form>
        </mat-card-content>
      </mat-card>

      <!-- Gestion des colonnes -->
      <mat-card class="columns-card" *ngIf="selectedTemplate">
        <mat-card-header>
          <mat-card-title>
            <mat-icon>view_column</mat-icon>
            Colonnes
            <button mat-icon-button (click)="addColumn()" class="add-button">
              <mat-icon>add</mat-icon>
            </button>
          </mat-card-title>
        </mat-card-header>
        
        <mat-card-content>
          <div class="columns-list">
            <div *ngFor="let column of selectedTemplate.columns; let i = index" class="column-item">
              <mat-checkbox [(ngModel)]="column.visible" (change)="updateDisplayedColumns()">
                {{ column.label || column.field }}
              </mat-checkbox>
              <div class="column-details">
                <span class="column-type">{{ column.type }}</span>
                <span class="column-aggregate" *ngIf="column.aggregate">{{ column.aggregate }}</span>
              </div>
              <button mat-icon-button (click)="removeColumn(i)" color="warn">
                <mat-icon>delete</mat-icon>
              </button>
            </div>
          </div>
        </mat-card-content>
      </mat-card>

      <!-- Gestion des filtres -->
      <mat-card class="filters-card" *ngIf="selectedTemplate">
        <mat-card-header>
          <mat-card-title>
            <mat-icon>filter_list</mat-icon>
            Filtres
          </mat-card-title>
        </mat-card-header>
        
        <mat-card-content>
          <form [formGroup]="filterForm" class="filter-form">
            <div class="filter-row">
              <mat-form-field appearance="outline">
                <mat-label>Champ</mat-label>
                <input matInput formControlName="field" placeholder="Nom du champ">
              </mat-form-field>
              
              <mat-form-field appearance="outline">
                <mat-label>Opérateur</mat-label>
                <mat-select formControlName="operator">
                  <mat-option *ngFor="let op of filterOperators" [value]="op.value">
                    {{ op.label }}
                  </mat-option>
                </mat-select>
              </mat-form-field>
              
              <mat-form-field appearance="outline">
                <mat-label>Valeur</mat-label>
                <input matInput formControlName="value" placeholder="Valeur">
              </mat-form-field>
              
              <button mat-raised-button (click)="addFilter()">
                <mat-icon>add</mat-icon>
                Ajouter
              </button>
            </div>
          </form>
          
          <div class="filters-list">
            <div *ngFor="let filter of selectedTemplate.filters; let i = index" class="filter-item">
              <span class="filter-text">{{ filter.field }} {{ filter.operator }} {{ filter.value }}</span>
              <button mat-icon-button (click)="removeFilter(i)" color="warn">
                <mat-icon>delete</mat-icon>
              </button>
            </div>
          </div>
        </mat-card-content>
      </mat-card>

    </div>

    <!-- Panneau de résultats -->
    <div class="results-panel">
      
      <!-- Résultats du rapport -->
      <mat-card class="results-card" *ngIf="reportData">
        <mat-card-header>
          <mat-card-title>
            <mat-icon>table_chart</mat-icon>
            Résultats du rapport
            <div class="export-actions">
              <button mat-button (click)="exportReport('excel')">
                <mat-icon>table_chart</mat-icon>
                Excel
              </button>
              <button mat-button (click)="exportReport('pdf')">
                <mat-icon>picture_as_pdf</mat-icon>
                PDF
              </button>
              <button mat-button (click)="exportReport('csv')">
                <mat-icon>file_download</mat-icon>
                CSV
              </button>
            </div>
          </mat-card-title>
        </mat-card-header>
        
        <mat-card-content>
          <div class="report-summary" *ngIf="reportData.summary">
            <h4>Résumé</h4>
            <div class="summary-grid">
              <div *ngFor="let key of getSummaryKeys()" class="summary-item">
                <label>{{ getColumnLabel(key) }}:</label>
                <span [class.currency]="getColumnType(key) === 'currency'">
                  {{ getColumnType(key) === 'currency' ? formatCurrency(reportData.summary[key]) : reportData.summary[key] }}
                </span>
              </div>
            </div>
          </div>
          
          <div class="table-container">
            <table mat-table [dataSource]="dataSource" matSort class="report-table">
              <ng-container *ngFor="let column of displayedColumns" [matColumnDef]="column">
                <th mat-header-cell *matHeaderCellDef mat-sort-header>
                  {{ getColumnLabel(column) }}
                </th>
                <td mat-cell *matCellDef="let row">
                  <span *ngIf="getColumnType(column) === 'currency'">
                    {{ formatCurrency(row[column]) }}
                  </span>
                  <span *ngIf="getColumnType(column) === 'date'">
                    {{ formatDate(row[column]) }}
                  </span>
                  <span *ngIf="getColumnType(column) !== 'currency' && getColumnType(column) !== 'date'">
                    {{ row[column] }}
                  </span>
                </td>
              </ng-container>
              
              <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
              <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>
            </table>
          </div>
          
          <mat-paginator [pageSizeOptions]="[10, 25, 50, 100]" showFirstLastButtons></mat-paginator>
        </mat-card-content>
      </mat-card>

      <!-- Message d'état -->
      <div class="empty-state" *ngIf="!reportData && !isLoading">
        <mat-icon class="empty-icon">assessment</mat-icon>
        <h2>Aucun rapport généré</h2>
        <p>Sélectionnez un modèle et générez un rapport pour voir les résultats.</p>
      </div>

    </div>

  </div>

  <!-- Loading spinner -->
  <div class="loading-container" *ngIf="isLoading">
    <mat-spinner></mat-spinner>
    <p>Génération du rapport en cours...</p>
  </div>

</div>
